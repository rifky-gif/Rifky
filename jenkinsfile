pipeline {
  agent any
  environment {
    IMAGE_NAME = 'rifky014/simple-app'        
    REGISTRY_CREDENTIALS = 'dockerhub-credentials'
  }

  stages {
    stage('Checkout') {
      steps {
        checkout scm
      }
    }

    stage('Unit Test') {
      steps {
        bat '''
        echo Menjalankan Unit Test dengan pytest...
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pytest --maxfail=1 --disable-warnings -q
        '''
      }
    }

    stage('Build Docker Image') {
      // hanya dijalankan jika test lulus
      when {
        expression { currentBuild.resultIsBetterOrEqualTo('SUCCESS') }
      }
      steps {
        bat '''
        echo Membuat Docker image...
        docker build -t %IMAGE_NAME%:%BUILD_NUMBER% .
        '''
      }
    }

    stage('Push Docker Image') {
      // hanya dijalankan jika test & build sukses
      when {
        expression { currentBuild.resultIsBetterOrEqualTo('SUCCESS') }
      }
      steps {
        withCredentials([usernamePassword(credentialsId: REGISTRY_CREDENTIALS, usernameVariable: 'USER', passwordVariable: 'PASS')]) {
          bat '''
          echo Login ke Docker Hub...
          docker login -u %USER% -p %PASS%
          echo Push image ke Docker Hub...
          docker push %IMAGE_NAME%:%BUILD_NUMBER%
          docker tag %IMAGE_NAME%:%BUILD_NUMBER% %IMAGE_NAME%:latest
          docker push %IMAGE_NAME%:latest
          '''
        }
      }
    }
  }

  post {
    success {
      bat 'echo "Pipeline berhasil dijalankan dan image sudah di-push ke Docker Hub!"'
    }
    failure {
      bat 'echo "Unit test gagal atau build gagal. Proses dihentikan."'
    }
    always {
      bat 'echo "Build selesai."'
    }
  }
}
